<% available = defined?(available_players) ? available_players : Player.where.not(id: match.participations.select(:player_id)) %>

<div class="modal fade" id="addParticipationsModal" tabindex="-1" aria-hidden="true"
     aria-labelledby="addParticipationsLabel-<%= match.id %>">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content border border-warning bg-dark text-light rounded-4">

      <div class="modal-header bg-dark border-0 border-bottom border-warning">
        <h5 class="modal-title text-warning" id="addParticipationsLabel-<%= match.id %>">
          <i class="fas fa-users me-2"></i>Agregar jugadores al partido
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <% if available.blank? %>
          <p class="text-center text-muted mb-0">No hay jugadores disponibles para inscribir.</p>
        <% else %>
          <%= form_with url: bulk_create_match_participations_path(match), method: :post, local: true do %>

            <p class="small text-muted mb-3">
              <i class="fas fa-location-dot me-1"></i>
              <strong class="me-2"><%= match.location.presence || "Ubicación no disponible" %></strong> ·
              <i class="fas fa-calendar-alt mx-2"></i><%= date_in_spanish(match.date) %>
            </p>

            <div class="row g-3">
              <!-- Columna Equipo Home -->
              <div class="col-12 col-lg-6">
                <div class="card shadow-sm border border-warning bg-dark rounded-3 h-100">
                  <div class="card-header bg-transparent border-0 d-flex flex-wrap align-items-center gap-2">
                    <span class="fw-bold text-warning">
                      <i class="fas fa-shirt me-1"></i><%= match.home_team&.name || 'Equipo Blanco' %>
                    </span>
                    <span class="ms-auto small">
                      <span id="home-count">0</span> seleccionados
                    </span>
                  </div>
                  <div class="card-body pt-2">
                    <div class="input-group input-group-sm mb-2">
                      <span class="input-group-text bg-dark text-warning border-warning"><i class="fas fa-search"></i></span>
                      <input type="text" class="form-control bg-dark text-light border-warning" id="home-filter"
                             placeholder="Buscar jugador...">
                      <button class="btn btn-outline-warning" type="button" id="home-clear">Limpiar</button>
                    </div>

                    <ul class="list-group list-group-flush" id="home-list" style="max-height: 380px; overflow-y:auto;">
                      <% available.each do |pl| %>
                        <li class="list-group-item bg-dark text-light border-secondary d-flex align-items-center justify-content-between"
                            data-name="<%= pl.full_name.downcase %>" data-player-id="<%= pl.id %>">
                          <div class="d-flex align-items-center gap-2">
                            <% if pl.profile_photo.attached? %>
                              <%= image_tag pl.profile_photo, class: "rounded-circle border border-warning", style: "width:36px;height:36px;object-fit:cover;" %>
                            <% else %>
                              <%= image_tag "default_avatar.png", class: "rounded-circle border border-warning", width: 36, height: 36 %>
                            <% end %>
                            <span class="small fw-semibold"><%= pl.full_name_with_win %></span>
                          </div>
                          <div class="form-check m-0">
                            <input class="form-check-input home-checkbox" type="checkbox"
                                   value="<%= pl.id %>" id="home_<%= pl.id %>" name="home_player_ids[]">
                          </div>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Columna Equipo Away -->
              <div class="col-12 col-lg-6">
                <div class="card shadow-sm border border-warning bg-dark rounded-3 h-100">
                  <div class="card-header bg-transparent border-0 d-flex flex-wrap align-items-center gap-2">
                    <span class="fw-bold text-warning">
                      <i class="fas a-shirt me-1"></i><%= match.away_team&.name || 'Equipo Negro' %>
                    </span>
                    <span class="ms-auto small">
                      <span id="away-count">0</span> seleccionados
                    </span>
                  </div>
                  <div class="card-body pt-2">
                    <div class="input-group input-group-sm mb-2">
                      <span class="input-group-text bg-dark text-warning border-warning"><i class="fas fa-search"></i></span>
                      <input type="text" class="form-control bg-dark text-light border-warning" id="away-filter"
                             placeholder="Buscar jugador...">
                      <button class="btn btn-outline-warning" type="button" id="away-clear">Limpiar</button>
                    </div>

                    <ul class="list-group list-group-flush" id="away-list" style="max-height: 380px; overflow-y:auto;">
                      <% available.each do |pl| %>
                        <li class="list-group-item bg-dark text-light border-secondary d-flex align-items-center justify-content-between"
                            data-name="<%= pl.full_name.downcase %>" data-player-id="<%= pl.id %>">
                          <div class="d-flex align-items-center gap-2">
                            <% if pl.profile_photo.attached? %>
                              <%= image_tag pl.profile_photo, class: "rounded-circle border border-warning", style: "width:36px;height:36px;object-fit:cover;" %>
                            <% else %>
                              <%= image_tag "default_avatar.png", class: "rounded-circle border border-warning", width: 36, height: 36 %>
                            <% end %>
                            <span class="small fw-semibold"><%= pl.full_name %></span>
                          </div>
                          <div class="form-check m-0">
                            <input class="form-check-input away-checkbox" type="checkbox"
                                   value="<%= pl.id %>" id="away_<%= pl.id %>" name="away_player_ids[]">
                          </div>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <div class="text-end mt-4">
              <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-warning" id="bulkSubmitMulti" disabled>Agregar seleccionados</button>
            </div>

          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
    /* ----- LÓGICA ROBUSTA CON EVENT DELEGATION ----- */
    (function () {
        function modalEl() {
            return document.getElementById('addParticipationsModal');
        }

        function updateCounts(modal) {
            const homeChecked = modal.querySelectorAll('.home-checkbox:checked').length;
            const awayChecked = modal.querySelectorAll('.away-checkbox:checked').length;
            const homeCount   = modal.querySelector('#home-count');
            const awayCount   = modal.querySelector('#away-count');
            const submitBtn   = modal.querySelector('#bulkSubmitMulti');

            if (homeCount) homeCount.textContent = homeChecked;
            if (awayCount) awayCount.textContent = awayChecked;
            if (submitBtn) submitBtn.disabled = (homeChecked + awayChecked === 0);
        }

        function toggleCounterpart(modal, changedBox) {
            const id = changedBox.value;
            const isHome = changedBox.classList.contains('home-checkbox');
            const counterpart = modal.querySelector(isHome ? `#away_${id}` : `#home_${id}`);
            if (!counterpart) return;

            const li = counterpart.closest('li');

            if (changedBox.checked) {
                counterpart.checked  = false;
                counterpart.disabled = true;
                li && li.classList.add('opacity-50');
            } else {
                counterpart.disabled = false;
                li && li.classList.remove('opacity-50');
            }
        }

        // Change en cualquier checkbox dentro del modal
        function onChange(e) {
            const modal = modalEl();
            if (!modal || !modal.contains(e.target)) return;

            if (e.target.classList.contains('home-checkbox') || e.target.classList.contains('away-checkbox')) {
                toggleCounterpart(modal, e.target);
                updateCounts(modal);
            }
        }

        // Filtros
        function onInput(e) {
            const modal = modalEl();
            if (!modal || !modal.contains(e.target)) return;

            if (e.target.id === 'home-filter' || e.target.id === 'away-filter') {
                const list = modal.querySelector(e.target.id === 'home-filter' ? '#home-list' : '#away-list');
                const q = e.target.value.trim().toLowerCase();
                list?.querySelectorAll('li').forEach(li => {
                    const name = li.getAttribute('data-name') || '';
                    li.style.display = name.includes(q) ? '' : 'none';
                });
            }
        }

        // Botones limpiar
        function onClick(e) {
            const modal = modalEl();
            if (!modal || !modal.contains(e.target)) return;

            if (e.target.id === 'home-clear') {
                const input = modal.querySelector('#home-filter');
                if (input) { input.value = ''; input.dispatchEvent(new Event('input')); input.focus(); }
            } else if (e.target.id === 'away-clear') {
                const input = modal.querySelector('#away-filter');
                if (input) { input.value = ''; input.dispatchEvent(new Event('input')); input.focus(); }
            }
        }

        // Recalcular al mostrar el modal (soporta Bootstrap + Turbo)
        function onModalShown(e) {
            if (e.target && e.target.id === 'addParticipationsModal') {
                updateCounts(e.target);
            }
        }

        document.addEventListener('change', onChange);
        document.addEventListener('input', onInput);
        document.addEventListener('click', onClick);
        document.addEventListener('DOMContentLoaded', () => { const m = modalEl(); if (m) updateCounts(m); });
        document.addEventListener('turbo:load',   () => { const m = modalEl(); if (m) updateCounts(m); });
        document.addEventListener('shown.bs.modal', onModalShown);
    })();
</script>
