<% last_month = Date.today.last_month %>
<% last_month_range = last_month.beginning_of_month..last_month.end_of_month %>

<% sorted_players = Player
  .joins(participations: :match)
  .where(matches: { date: last_month_range })
  .group(:id)
  .select('players.*,
           COUNT(*) AS total_matches,
           COUNT(CASE WHEN participations.team_id = matches.win_id THEN 1 END) AS victories')
  .map do |player|
  mvp_count = Match.where(date: last_month_range, mvp_id: player.id).count
  player.define_singleton_method(:mvp_count) { mvp_count }
  player
end
  .sort_by { |player| [-player.victories.to_i, -player.mvp_count, -player.total_matches.to_i] } %>

<% grouped_by_stats = sorted_players
  .group_by { |p| [p.victories.to_i, p.mvp_count.to_i, p.total_matches.to_i] }
  .sort_by { |(wins, mvps, games), _| [-wins, -mvps, -games] } %>

<% ranked_players = [] %>
<% grouped_by_stats.each_with_index do |(_, players), real_position| %>
  <% break if ranked_players.size >= 3 %>
  <% players.each do |player| %>
    <% break if ranked_players.size >= 3 %>
    <% ranked_players << { player: player, position: real_position + 1, tie: players.size > 1 } %>
  <% end %>
<% end %>

<% if ranked_players.any? %>
  <div class="row">
    <% ranked_players.each do |entry| %>
      <% player = entry[:player] %>
      <% position = entry[:position] %>
      <% tie = entry[:tie] %>

      <% mvp_count = Match.where(date: last_month_range, mvp_id: player.id).count %>
      <% total_games = player.participations
                             .joins(:match)
                             .where(matches: { date: last_month_range })
                             .count %>
      <% wins = player.participations
                      .joins(:match)
                      .where(matches: { date: last_month_range })
                      .where('participations.team_id = matches.win_id')
                      .count %>
      <% win_percentage = total_games > 0 ? (100.0 * wins / total_games).round : 0 %>

      <div class="col-md-4 mb-4">
        <%= link_to player_path(player), class: "text-decoration-none text-dark" do %>
          <div class="card shadow-sm h-100 border border-warning bg-dark text-light card-gold">
            <div class="card-body d-flex flex-column align-items-center text-center">
              <!-- Foto -->
              <div class="mb-3">
                <% if player.profile_photo.attached? %>
                  <%= image_tag player.profile_photo,
                                class: "rounded-circle border border-3 border-warning",
                                style: "width: 90px; height: 90px; object-fit: cover;" %>
                <% else %>
                  <%= image_tag "default_avatar.png",
                                class: "rounded-circle border border-3 border-warning",
                                width: 90, height: 90 %>
                <% end %>
              </div>

              <!-- TÃ­tulo -->
              <h5 class="fw-bold text-warning mb-1">
                <i class="fas fa-star me-2"></i>
                <% if position == 1 && tie %>
                  Empatado en el primer lugar
                <% elsif position == 2 && tie %>
                  Empatado en el segundo lugar
                <% elsif position == 3 && tie %>
                  Empatado en el tercer lugar
                <% else %>
                  <%= position == 1 ? "Jugador del Mes" : "Top #{position}" %>
                <% end %>
              </h5>

              <!-- Nombre -->
              <p class="mb-1 text-light fw-semibold"><%= player.full_name %></p>

              <!-- Stats -->
              <div class="small text-light">
                ğŸŸï¸ Partidos: <strong><%= total_games %></strong><br>
                ğŸ† Victorias: <strong><%= wins %></strong><br>
                âœ¨ MVPs: <strong><%= mvp_count %></strong><br>
                ğŸ“ˆ <strong class="text-success"><%= win_percentage %>%</strong> victorias
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
