<!-- app/views/players/win_ranking.html.erb -->

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-2">🏆 Ranking de Victorias 🏆</h1>
  <%= render "season_selector" %>
</div>

<p class="text-center text-muted small mb-4">
  Mostrando <strong><%= @selected_season ? @selected_season.name : "Global" %></strong>.
  El Win Rate se muestra a partir de <%= Player::MIN_MATCHES %> partidos.
  Los que aún no llegan verán un “modo pretemporada”. 😉
</p>

<div class="table-responsive shadow-lg rounded bg-light">
  <table class="table table-hover align-middle mb-0 ranking-table">
    <thead class="table-dark text-center">
    <tr>
      <th>Posición</th>
      <th>Jugador</th>
      <th>Balance</th>
      <th>Win Rate</th>
      <th>Racha</th>
    </tr>
    </thead>

    <tbody class="table-dark">
    <% @top_players.each_with_index do |player, index| %>
      <% border_class =
           case index
           when 0 then 'gold-border'
           when 1 then 'silver-border'
           when 2 then 'bronze-border'
           else ''
           end %>

      <% min_pj  = Player::MIN_MATCHES %>
      <% jugados = player.stat_total_matches.to_i %>
      <% eligible = jugados >= min_pj %>

      <tr class="bg-dark text-light <%= border_class %>">
        <!-- Posición -->
        <td class="text-center fs-4">
          <%= render "tables/top_three", index: %>
        </td>

        <!-- Jugador -->
        <td class="text-start d-flex align-items-center gap-3 px-3 py-2">
          <% if player.profile_photo.attached? %>
            <%= image_tag player.profile_photo,
                          class: "rounded-circle border border-light",
                          width: 40, height: 40,
                          style: "object-fit: cover;" %>
          <% else %>
            <%= image_tag "default_avatar.png",
                          class: "rounded-circle border border-light",
                          width: 40, height: 40 %>
          <% end %>
          <%= link_to player.name, player_path(player),
                      class: "text-decoration-none text-light fw-semibold" %>
        </td>

        <!-- Balance (usa stats persistidos) -->
        <td class="text-center">
            <span class="badge <%= player.stat_win_diff.to_i >= 0 ? 'bg-success' : 'bg-danger' %>">
              <%= player.stat_win_diff.to_i >= 0 ? '+' : '−' %><%= player.stat_win_diff.to_i.abs %>
            </span>
          <span class="badge bg-dark border">
              <span class="text-success fw-bold"><%= player.stat_total_wins %>W</span>
              <span class="text-muted">·</span>
              <span class="text-danger fw-bold"><%= player.stat_total_losses %>L</span>
            </span>
        </td>

        <!-- Win Rate (solo con stats persistidos) -->
        <td class="text-center">
          <% if eligible && jugados.positive? %>
            <% wr_pct = player.stat_win_rate_pct.presence ||
                        ((player.stat_total_wins.to_f / jugados) * 100).round(1) %>
            <div class="small fw-semibold"><%= wr_pct %>%</div>
            <div class="progress" style="height:8px">
              <div class="progress-bar bg-success" style="width:<%= wr_pct %>%"></div>
              <div class="progress-bar bg-danger"  style="width:<%= (100 - wr_pct).round(1) %>%"></div>
            </div>
          <% else %>
            <div class="small text-muted fw-semibold"><%= min_pj %> PJ y hablamos 😉</div>
          <% end %>
        </td>

        <!-- Racha -->
        <td class="text-center racha-mobile">
          <% if player.current_streak.positive? %>
            <span class="badge bg-warning text-dark">🔥 <%= player.current_streak %>W</span>
          <% elsif player.current_streak.negative? %>
            <span class="badge bg-secondary">❄️ <%= player.current_streak.abs %>L</span>
          <% else %>
            <span class="badge bg-light text-dark">—</span>
          <% end %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>
