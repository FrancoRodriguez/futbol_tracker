<h1 class="text-center mb-2">🏆 Ranking de Victorias 🏆</h1>
<p class="text-center text-muted small mb-4">
  El Win Rate se muestra a partir de <%= Player::MIN_MATCHES %> partidos. Los que aún no llegan verán un “modo pretemporada”. 😉
</p>

<div class="table-responsive shadow-lg rounded bg-light">
  <table class="table table-hover align-middle mb-0 ranking-table">
    <thead class="table-dark text-center">
    <tr>
      <th>Posición</th>
      <th>Jugador</th>
      <th>Balance</th>
      <th>Win Rate</th>
      <th>Racha</th>
    </tr>
    </thead>

    <tbody class="table-dark">
    <% @top_players.each_with_index do |player, index| %>
      <% border_class = case index
                        when 0 then 'gold-border'
                        when 1 then 'silver-border'
                        when 2 then 'bronze-border'
                        else ''
                        end %>

      <% min_pj   = Player::MIN_MATCHES %>
      <% jugados  = player.total_matches.to_i %>
      <% faltan   = [min_pj - jugados, 0].max %>
      <% progreso = ((jugados.to_f / min_pj) * 100).clamp(0, 100).round %>
      <% eligible = jugados >= min_pj %>

      <% # Calcula WR solo si es elegible; respeta win_rate_pct si existe, si no calcula %>
      <% wr_pct = nil %>
      <% if eligible %>
        <% wr_pct = if player.respond_to?(:win_rate_pct) && player.win_rate_pct.present?
                      player.win_rate_pct
                    elsif player.total_matches.to_i > 0
                      ((player.total_wins.to_f / player.total_matches.to_f) * 100).round(1)
                    end %>
      <% end %>

      <tr class="bg-dark text-light <%= border_class %>">
        <!-- Posición -->
        <td class="text-center fs-4">
          <%= render "tables/top_three", index: %>
        </td>

        <!-- Jugador -->
        <td class="text-start d-flex align-items-center gap-3 px-3 py-2">
          <% if player.profile_photo.attached? %>
            <%= image_tag player.profile_photo,
                          class: "rounded-circle border border-light",
                          width: 40, height: 40,
                          style: "object-fit: cover;" %>
          <% else %>
            <%= image_tag "default_avatar.png",
                          class: "rounded-circle border border-light",
                          width: 40, height: 40 %>
          <% end %>
          <%= link_to player.name, player_path(player),
                      class: "text-decoration-none text-light fw-semibold" %>
        </td>

        <!-- Balance -->
        <td class="text-center balance-mobile">
          <div class="d-inline-flex align-items-center gap-2 flex-wrap justify-content-center">
              <span class="badge <%= player.win_diff.to_i >= 0 ? 'bg-success' : 'bg-danger' %>">
                <%= player.win_diff.to_i >= 0 ? '+' : '−' %><%= player.win_diff.to_i.abs %>
              </span>
            <span class="badge bg-dark border">
                <span class="text-success fw-bold"><%= player.total_wins %>W</span>
                <span class="text-muted">·</span>
                <span class="text-danger fw-bold"><%= player.total_losses %>L</span>
              </span>
          </div>
        </td>

        <!-- Win Rate -->
        <td class="text-center">
          <% min_pj   = Player::MIN_MATCHES %>
          <% jugados  = player.total_matches.to_i %>
          <% eligible = jugados >= min_pj %>

          <% if eligible && player.total_matches.to_i > 0 %>
            <% wr_pct = if player.respond_to?(:win_rate_pct) && player.win_rate_pct.present?
                          player.win_rate_pct
                        else
                          ((player.total_wins.to_f / player.total_matches.to_f) * 100).round(1)
                        end %>

            <div class="small fw-semibold"><%= wr_pct %>%</div>
            <div class="progress" style="height:8px">
              <div class="progress-bar bg-success" style="width:<%= wr_pct %>%"></div>
              <div class="progress-bar bg-danger"  style="width:<%= (100 - wr_pct).round(1) %>%"></div>
            </div>
          <% else %>
            <div class="small text-muted fw-semibold">5 PJ y hablamos 😉</div>
          <% end %>
        </td>


        <!-- Racha -->
        <td class="text-center racha-mobile">
          <% if player.current_streak.positive? %>
            <span class="badge bg-warning text-dark">🔥 <%= player.current_streak %>W</span>
          <% elsif player.current_streak.negative? %>
            <span class="badge bg-secondary">❄️ <%= player.current_streak.abs %>L</span>
          <% else %>
            <span class="badge bg-light text-dark">—</span>
          <% end %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>
