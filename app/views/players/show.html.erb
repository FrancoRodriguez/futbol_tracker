<div class="container my-5">
  <!-- Nombre del jugador -->
  <div class="text-center mb-4">
    <h1 class="display-4 fw-bold"><%= @player.full_name %></h1>
  </div>

  <!-- Foto de perfil -->
  <% if @player.profile_photo.attached? %>
    <div class="d-flex justify-content-center mb-4">
      <div class="position-relative" style="width: 160px; height: 160px;">
        <%= image_tag @player.profile_photo, alt: @player.full_name,
                      class: "rounded-circle shadow border border-3 border-white",
                      style: "object-fit: cover; width: 100%; height: 100%;" %>
      </div>
    </div>
  <% end %>

  <!-- Botón de edición -->
  <% if user_signed_in? %>
    <div class="text-center mb-5">
      <%= link_to 'Editar Jugador', edit_player_path(@player), class: 'btn btn-outline-primary btn-lg px-5' %>
    </div>
  <% end %>

  <!-- Información de contacto -->
  <% if @player.contact_info.present? %>
    <div class="card shadow-sm mb-4">
      <div class="card-body d-flex align-items-center">
        <i class="fas fa-phone-alt fa-2x me-3 text-success"></i>
        <div>
          <h5 class="card-title mb-1">Información de Contacto</h5>
            <%= link_to 'WhatsApp', "https://wa.me/#{@player.contact_info.gsub(/\D/, '')}", target: "_blank", class: "btn btn-success btn-sm mt-1" %>
          <%= link_to 'WhatsApp', "https://wa.me/#{@player.contact_info.gsub(/\D/, '')}", target: "_blank", class: "btn btn-success btn-sm mt-1" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Estadísticas -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3"><i class="fas fa-chart-bar me-2"></i>Estadísticas del Jugador</h5>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-dark">
          <tr>
            <th><i class="fas fa-signal"></i> Partidos Jugados</th>
            <th><i class="fas fa-trophy"></i> Victorias</th>
            <th><i class="fas fa-frown"></i> Derrotas</th>
            <th><i class="fas fa-meh"></i> Empates</th>
            <th><i class="fas fa-star"></i> Veces MVP</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td><%= @player.participations.joins(:match).where('matches.date < ?', Date.today).count %></td>
            <td><%= @results_count[:victories] %></td>
            <td><%= @results_count[:defeats] %></td>
            <td><%= @results_count[:draws] %></td>
            <td><%= @player.mvp_matches.count %></td>
          </tr>
          </tbody>
        </table>
        <table class="table table-bordered text-center mt-3">
          <tbody>
          <tr>
            <th>Porcentaje de Victorias</th>
            <td colspan="4"><strong><%= "#{@win_rate}%" %></strong></td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Balance histórico -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3"><i class="fas fa-chart-line me-2"></i>Balance histórico</h5>
      <canvas id="balanceChart" width="600" height="300"></canvas>
    </div>
  </div>

  <!-- Historial de Participaciones -->
  <% if @participations.any? %>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Historial de Participaciones</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-dark">
            <tr>
              <th>Partido</th>
              <th>Equipo</th>
              <th>Resultado</th>
            </tr>
            </thead>
            <tbody>
            <% @participations.each do |participation| %>
              <tr class="align-middle">
                <td><%= link_to "Partido #{participation.match.date}", match_path(participation.match) %></td>
                <td><%= participation.team.name %></td>
                <td class="text-center"><%= render "matches/result", match: participation.match %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-center mt-3">
          <%= paginate @participations %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="alert alert-warning" role="alert">
      Este jugador aún no ha participado en ningún partido.
    </div>
  <% end %>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("turbo:load", drawBalanceChart);
    document.addEventListener("turbolinks:load", drawBalanceChart);

    function drawBalanceChart() {
        const ctx = document.getElementById('balanceChart');
        if (!ctx) return;

        const chartContext = ctx.getContext('2d');
        const balanceData = <%= raw @chart_data[:balance].to_json %>;
        const labels = <%= raw @chart_data[:dates].to_json %>;

        if (window.balanceChartInstance) {
            window.balanceChartInstance.destroy();
        }

        window.balanceChartInstance = new Chart(chartContext, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Balance (Victorias - Derrotas)',
                    data: balanceData,
                    fill: {
                        target: 'origin',
                        above: 'rgba(75, 192, 192, 0.2)',  // Verde claro para positivo
                        below: 'rgba(255, 99, 132, 0.2)'   // Rojo claro para negativo
                    },
                    tension: 0.1,
                    borderWidth: 2,
                    borderColor: 'rgba(0,0,0,0)', // invisible, lo pinta el segment
                    segment: {
                        borderColor: ctx =>
                            (ctx.p0.parsed.y < 0 || ctx.p1.parsed.y < 0)
                                ? 'rgba(255, 99, 132, 1)'  // rojo para negativo
                                : 'rgba(75, 192, 192, 1)'  // verde para positivo
                    }
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Fecha' } },
                    y: {
                        title: { display: true, text: 'Balance acumulado' },
                        suggestedMin: Math.min(...balanceData) - 1,
                        suggestedMax: Math.max(...balanceData) + 1
                    }
                }
            }
        });
    }
</script>
